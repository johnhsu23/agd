"use strict";
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var Lint = require("tslint/lib/lint");
var ts = require("typescript");
var Rule = (function (_super) {
    __extends(Rule, _super);
    function Rule() {
        return _super.apply(this, arguments) || this;
    }
    Rule.prototype.apply = function (sourceFile) {
        return this.applyWithWalker(new ImportJqueryWalker(sourceFile, this.getOptions()));
    };
    return Rule;
}(Lint.Rules.AbstractRule));
exports.Rule = Rule;
Rule.FAILURE_STRING = 'Do not use global jQuery.';
var ImportJqueryWalker = (function (_super) {
    __extends(ImportJqueryWalker, _super);
    function ImportJqueryWalker() {
        return _super.apply(this, arguments) || this;
    }
    ImportJqueryWalker.prototype.createBlockScope = function () {
        if (this.blockScopeStack) {
            return Object.create(this.getCurrentBlockScope());
        }
        else {
            return Object.create(null);
        }
    };
    ImportJqueryWalker.prototype.createScope = function () {
        if (this.scopeStack) {
            return Object.create(this.getCurrentScope());
        }
        else {
            return Object.create(null);
        }
    };
    ImportJqueryWalker.prototype.sawDollarSign = function () {
        return this.getCurrentBlockScope().dollarSign
            || this.getAllScopes().some(function (scope) { return scope.dollarSign; });
    };
    ImportJqueryWalker.prototype.sawJquery = function () {
        return this.getCurrentBlockScope().jQuery
            || this.getAllScopes().some(function (scope) { return scope.jQuery; });
    };
    ImportJqueryWalker.prototype.inspect = function (scope, text) {
        switch (text) {
            case '$':
                scope.dollarSign = true;
                break;
            case 'jQuery':
                scope.jQuery = true;
                break;
        }
    };
    ImportJqueryWalker.prototype.visitImportDeclaration = function (node) {
        var scope = this.getCurrentScope();
        var clause = node.importClause;
        // This is an import like "import 'foo';"
        if (!clause) {
            return;
        }
        // Default import
        if (clause.name) {
            this.inspect(scope, clause.name.getText());
        }
        var bindings = clause.namedBindings;
        if (!bindings) {
            return;
        }
        // import * as foo from 'module';
        if (bindings.kind === ts.SyntaxKind.NamespaceImport) {
            return this.inspect(scope, bindings.name.getText());
        }
        // import {...} from 'module';
        if (bindings.kind === ts.SyntaxKind.NamedImports) {
            for (var _i = 0, _a = bindings.elements; _i < _a.length; _i++) {
                var element = _a[_i];
                this.inspect(scope, element.name.getText());
            }
        }
    };
    ImportJqueryWalker.prototype.visitClassExpression = function (node) {
        var scope = this.getCurrentBlockScope();
        if (node.name) {
            this.inspect(scope, node.name.getText());
        }
        return _super.prototype.visitClassExpression.call(this, node);
    };
    ImportJqueryWalker.prototype.visitClassDeclaration = function (node) {
        var scope = Object.getPrototypeOf(this.getCurrentBlockScope());
        if (node.name) {
            this.inspect(scope, node.name.getText());
        }
        return _super.prototype.visitClassDeclaration.call(this, node);
    };
    ImportJqueryWalker.prototype.visitFunctionExpression = function (node) {
        if (node.name) {
            this.inspect(this.getCurrentScope(), node.name.getText());
        }
        return _super.prototype.visitFunctionExpression.call(this, node);
    };
    ImportJqueryWalker.prototype.visitFunctionDeclaration = function (node) {
        var scope = Object.getPrototypeOf(this.getCurrentScope());
        if (node.name) {
            this.inspect(scope, node.name.getText());
        }
        return _super.prototype.visitFunctionDeclaration.call(this, node);
    };
    ImportJqueryWalker.prototype.visitParameterDeclaration = function (node) {
        var scope = this.getCurrentScope();
        var name = node.name;
        if (name.kind === ts.SyntaxKind.Identifier) {
            // (name)
            this.inspect(scope, name.getText());
        }
        else {
            // ({name}) or ([name]) or ...
            this.inspectBindings(scope, name);
        }
    };
    ImportJqueryWalker.prototype.visitIdentifier = function (node) {
        var ident = node.getText(), isFailure = (ident === '$' && !this.sawDollarSign())
            || (ident === 'jQuery' && !this.sawJquery());
        if (isFailure) {
            this.addFailure(this.createFailure(node.getStart(), node.getWidth(), Rule.FAILURE_STRING));
        }
    };
    ImportJqueryWalker.prototype.visitVariableStatement = function (node) {
        var list = node.declarationList;
        var isBlockScoped = (list.flags & (ts.NodeFlags.Const | ts.NodeFlags.Let)) !== 0;
        var scope = isBlockScoped ? this.getCurrentBlockScope() : this.getCurrentScope();
        for (var _i = 0, _a = list.declarations; _i < _a.length; _i++) {
            var decl = _a[_i];
            this.inspectDeclaration(scope, decl);
        }
    };
    ImportJqueryWalker.prototype.visitMethodDeclaration = function (node) {
        for (var _i = 0, _a = node.parameters; _i < _a.length; _i++) {
            var param = _a[_i];
            this.visitNode(param);
        }
        if (node.body) {
            this.visitNode(node.body);
        }
    };
    ImportJqueryWalker.prototype.visitPropertyAssignment = function (node) {
        this.visitNode(node.initializer);
    };
    ImportJqueryWalker.prototype.visitPropertyAccessExpression = function (node) {
        this.visitNode(node.expression);
    };
    ImportJqueryWalker.prototype.visitPropertyDeclaration = function (node) {
        if (node.initializer) {
            _super.prototype.visitNode.call(this, node.initializer);
        }
    };
    ImportJqueryWalker.prototype.inspectBindings = function (scope, node) {
        for (var _i = 0, _a = node.elements; _i < _a.length; _i++) {
            var binding = _a[_i];
            if (binding.kind !== ts.SyntaxKind.OmittedExpression) {
                this.inspectBinding(scope, binding);
                if (binding.initializer) {
                    this.visitNode(binding.initializer);
                }
            }
        }
    };
    ImportJqueryWalker.prototype.inspectBinding = function (scope, node) {
        if (node.kind === ts.SyntaxKind.BindingElement) {
            var name_1 = node.name;
            if (name_1.kind === ts.SyntaxKind.Identifier) {
                this.inspect(scope, name_1.getText());
            }
            else {
                this.inspectBindings(scope, name_1);
            }
            if (node.initializer) {
                this.visitNode(node.initializer);
            }
        }
    };
    ImportJqueryWalker.prototype.inspectDeclaration = function (scope, node) {
        var name = node.name;
        if (name.kind === ts.SyntaxKind.Identifier) {
            this.inspect(scope, name.getText());
        }
        else {
            this.inspectBindings(scope, name);
        }
        if (node.initializer) {
            this.visitNode(node.initializer);
        }
    };
    return ImportJqueryWalker;
}(Lint.BlockScopeAwareRuleWalker));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW1wb3J0SnF1ZXJ5UnVsZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImltcG9ydEpxdWVyeVJ1bGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsc0NBQXdDO0FBQ3hDLCtCQUFpQztBQUVqQztJQUEwQix3QkFBdUI7SUFBakQ7O0lBTUEsQ0FBQztJQUhRLG9CQUFLLEdBQVosVUFBYSxVQUF5QjtRQUNwQyxNQUFNLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLGtCQUFrQixDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQ3JGLENBQUM7SUFDSCxXQUFDO0FBQUQsQ0FBQyxBQU5ELENBQTBCLElBQUksQ0FBQyxLQUFLLENBQUMsWUFBWTtBQUFqRCxvQkFNQztBQUxlLG1CQUFjLEdBQUcsMkJBQTJCLENBQUM7QUFZN0Q7SUFBaUMsc0NBQThEO0lBQS9GOztJQWlOQSxDQUFDO0lBaE5RLDZDQUFnQixHQUF2QjtRQUNFLEVBQUUsQ0FBQyxDQUFFLElBQXNDLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQztZQUM1RCxNQUFNLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsb0JBQW9CLEVBQUUsQ0FBQyxDQUFDO1FBQ3BELENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNOLE1BQU0sQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzdCLENBQUM7SUFDSCxDQUFDO0lBRU0sd0NBQVcsR0FBbEI7UUFDRSxFQUFFLENBQUMsQ0FBRSxJQUFpQyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUM7WUFDbEQsTUFBTSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDLENBQUM7UUFDL0MsQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ04sTUFBTSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFD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QyxTQUFTLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBQ25DLENBQUM7UUFDSCxDQUFDO0lBQ0gsQ0FBQztJQUVTLCtDQUFrQixHQUE1QixVQUE2QixLQUFxQixFQUFFLElBQTRCO1FBQzlFLElBQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUM7UUFDdkIsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksS0FBSyxFQUFFLENBQUMsVUFBVSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUM7WUFDM0MsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUM7UUFDdEMsQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ04sSUFBSSxDQUFDLGVBQWUsQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDcEMsQ0FBQztRQUVELEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDO1lBQ3JCLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ25DLENBQUM7SUFDSCxDQUFDO0lBQ0gseUJBQUM7QUFBRCxDQUFDLEFBak5ELENBQWlDLElBQUksQ0FBQyx5QkFBeUIsR0FpTjlEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgTGludCBmcm9tICd0c2xpbnQvbGliL2xpbnQnO1xuaW1wb3J0ICogYXMgdHMgZnJvbSAndHlwZXNjcmlwdCc7XG5cbmV4cG9ydCBjbGFzcyBSdWxlIGV4dGVuZHMgTGludC5SdWxlcy5BYnN0cmFjdFJ1bGUge1xuICBwdWJsaWMgc3RhdGljIEZBSUxVUkVfU1RSSU5HID0gJ0RvIG5vdCB1c2UgZ2xvYmFsIGpRdWVyeS4nO1xuXG4gIHB1YmxpYyBhcHBseShzb3VyY2VGaWxlOiB0cy5Tb3VyY2VGaWxlKTogTGludC5SdWxlRmFpbHVyZVtdIHtcbiAgICByZXR1cm4gdGhpcy5hcHBseVdpdGhXYWxrZXIobmV3IEltcG9ydEpxdWVyeVdhbGtlcihzb3VyY2VGaWxlLCB0aGlzLmdldE9wdGlvbnMoKSkpO1xuICB9XG59XG5cbmludGVyZmFjZSBTYXdKcXVlcnlTY29wZSB7XG4gIGRvbGxhclNpZ246IGJvb2xlYW47XG4gIGpRdWVyeTogYm9vbGVhbjtcbn1cblxuY2xhc3MgSW1wb3J0SnF1ZXJ5V2Fsa2VyIGV4dGVuZHMgTGludC5CbG9ja1Njb3BlQXdhcmVSdWxlV2Fsa2VyPFNhd0pxdWVyeVNjb3BlLCBTYXdKcXVlcnlTY29wZT4ge1xuICBwdWJsaWMgY3JlYXRlQmxvY2tTY29wZSgpOiBTYXdKcXVlcnlTY29wZSB7XG4gICAgaWYgKCh0aGlzIGFzIHt9IGFzIHsgYmxvY2tTY29wZVN0YWNrOiB7fSB9KS5ibG9ja1Njb3BlU3RhY2spIHtcbiAgICAgIHJldHVybiBPYmplY3QuY3JlYXRlKHRoaXMuZ2V0Q3VycmVudEJsb2NrU2NvcGUoKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBPYmplY3QuY3JlYXRlKG51bGwpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBjcmVhdGVTY29wZSgpOiBTYXdKcXVlcnlTY29wZSB7XG4gICAgaWYgKCh0aGlzIGFzIHt9IGFzIHsgc2NvcGVTdGFjazoge30gfSkuc2NvcGVTdGFjaykge1xuICAgICAgcmV0dXJuIE9iamVjdC5jcmVhdGUodGhpcy5nZXRDdXJyZW50U2NvcGUoKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBPYmplY3QuY3JlYXRlKG51bGwpO1xuICAgIH1cbiAgfVxuXG4gIHByb3RlY3RlZCBzYXdEb2xsYXJTaWduKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLmdldEN1cnJlbnRCbG9ja1Njb3BlKCkuZG9sbGFyU2lnblxuICAgICAgICB8fCB0aGlzLmdldEFsbFNjb3BlcygpLnNvbWUoc2NvcGUgPT4gc2NvcGUuZG9sbGFyU2lnbik7XG4gIH1cblxuICBwcm90ZWN0ZWQgc2F3SnF1ZXJ5KCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLmdldEN1cnJlbnRCbG9ja1Njb3BlKCkualF1ZXJ5XG4gICAgICAgIHx8IHRoaXMuZ2V0QWxsU2NvcGVzKCkuc29tZShzY29wZSA9PiBzY29wZS5qUXVlcnkpO1xuICB9XG5cbiAgcHJvdGVjdGVkIGluc3BlY3Qoc2NvcGU6IFNhd0pxdWVyeVNjb3BlLCB0ZXh0OiBzdHJpbmcpOiB2b2lkIHtcbiAgICBzd2l0Y2ggKHRleHQpIHtcbiAgICAgIGNhc2UgJyQnOlxuICAgICAgICBzY29wZS5kb2xsYXJTaWduID0gdHJ1ZTtcbiAgICAgICAgYnJlYWs7XG5cbiAgICAgIGNhc2UgJ2pRdWVyeSc6XG4gICAgICAgIHNjb3BlLmpRdWVyeSA9IHRydWU7XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgfVxuXG4gIHByb3RlY3RlZCB2aXNpdEltcG9ydERlY2xhcmF0aW9uKG5vZGU6IHRzLkltcG9ydERlY2xhcmF0aW9uKTogdm9pZCB7XG4gICAgY29uc3Qgc2NvcGUgPSB0aGlzLmdldEN1cnJlbnRTY29wZSgpO1xuXG4gICAgY29uc3QgY2xhdXNlID0gbm9kZS5pbXBvcnRDbGF1c2U7XG5cbiAgICAvLyBUaGlzIGlzIGFuIGltcG9ydCBsaWtlIFwiaW1wb3J0ICdmb28nO1wiXG4gICAgaWYgKCFjbGF1c2UpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyBEZWZhdWx0IGltcG9ydFxuICAgIGlmIChjbGF1c2UubmFtZSkge1xuICAgICAgdGhpcy5pbnNwZWN0KHNjb3BlLCBjbGF1c2UubmFtZS5nZXRUZXh0KCkpO1xuICAgIH1cblxuICAgIGNvbnN0IGJpbmRpbmdzID0gY2xhdXNlLm5hbWVkQmluZGluZ3M7XG4gICAgaWYgKCFiaW5kaW5ncykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIGltcG9ydCAqIGFzIGZvbyBmcm9tICdtb2R1bGUnO1xuICAgIGlmIChiaW5kaW5ncy5raW5kID09PSB0cy5TeW50YXhLaW5kLk5hbWVzcGFjZUltcG9ydCkge1xuICAgICAgcmV0dXJuIHRoaXMuaW5zcGVjdChzY29wZSwgYmluZGluZ3MubmFtZS5nZXRUZXh0KCkpO1xuICAgIH1cblxuICAgIC8vIGltcG9ydCB7Li4ufSBmcm9tICdtb2R1bGUnO1xuICAgIGlmIChiaW5kaW5ncy5raW5kID09PSB0cy5TeW50YXhLaW5kLk5hbWVkSW1wb3J0cykge1xuICAgICAgZm9yIChjb25zdCBlbGVtZW50IG9mIGJpbmRpbmdzLmVsZW1lbnRzKSB7XG4gICAgICAgIHRoaXMuaW5zcGVjdChzY29wZSwgZWxlbWVudC5uYW1lLmdldFRleHQoKSk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJvdGVjdGVkIHZpc2l0Q2xhc3NFeHByZXNzaW9uKG5vZGU6IHRzLkNsYXNzRXhwcmVzc2lvbik6IHZvaWQge1xuICAgIGNvbnN0IHNjb3BlID0gdGhpcy5nZXRDdXJyZW50QmxvY2tTY29wZSgpO1xuXG4gICAgaWYgKG5vZGUubmFtZSkge1xuICAgICAgdGhpcy5pbnNwZWN0KHNjb3BlLCBub2RlLm5hbWUuZ2V0VGV4dCgpKTtcbiAgICB9XG5cbiAgICByZXR1cm4gc3VwZXIudmlzaXRDbGFzc0V4cHJlc3Npb24obm9kZSk7XG4gIH1cblxuICBwcm90ZWN0ZWQgdmlzaXRDbGFzc0RlY2xhcmF0aW9uKG5vZGU6IHRzLkNsYXNzRGVjbGFyYXRpb24pOiB2b2lkIHtcbiAgICBjb25zdCBzY29wZSA9IE9iamVjdC5nZXRQcm90b3R5cGVPZih0aGlzLmdldEN1cnJlbnRCbG9ja1Njb3BlKCkpO1xuXG4gICAgaWYgKG5vZGUubmFtZSkge1xuICAgICAgdGhpcy5pbnNwZWN0KHNjb3BlLCBub2RlLm5hbWUuZ2V0VGV4dCgpKTtcbiAgICB9XG5cbiAgICByZXR1cm4gc3VwZXIudmlzaXRDbGFzc0RlY2xhcmF0aW9uKG5vZGUpO1xuICB9XG5cbiAgcHJvdGVjdGVkIHZpc2l0RnVuY3Rpb25FeHByZXNzaW9uKG5vZGU6IHRzLkZ1bmN0aW9uRXhwcmVzc2lvbik6IHZvaWQge1xuICAgIGlmIChub2RlLm5hbWUpIHtcbiAgICAgIHRoaXMuaW5zcGVjdCh0aGlzLmdldEN1cnJlbnRTY29wZSgpLCBub2RlLm5hbWUuZ2V0VGV4dCgpKTtcbiAgICB9XG5cbiAgICByZXR1cm4gc3VwZXIudmlzaXRGdW5jdGlvbkV4cHJlc3Npb24obm9kZSk7XG4gIH1cblxuICBwcm90ZWN0ZWQgdmlzaXRGdW5jdGlvbkRlY2xhcmF0aW9uKG5vZGU6IHRzLkZ1bmN0aW9uRGVjbGFyYXRpb24pOiB2b2lkIHtcbiAgICBjb25zdCBzY29wZSA9IE9iamVjdC5nZXRQcm90b3R5cGVPZih0aGlzLmdldEN1cnJlbnRTY29wZSgpKTtcblxuICAgIGlmIChub2RlLm5hbWUpIHtcbiAgICAgIHRoaXMuaW5zcGVjdChzY29wZSwgbm9kZS5uYW1lLmdldFRleHQoKSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHN1cGVyLnZpc2l0RnVuY3Rpb25EZWNsYXJhdGlvbihub2RlKTtcbiAgfVxuXG4gIHByb3RlY3RlZCB2aXNpdFBhcmFtZXRlckRlY2xhcmF0aW9uKG5vZGU6IHRzLlBhcmFtZXRlckRlY2xhcmF0aW9uKTogdm9pZCB7XG4gICAgY29uc3Qgc2NvcGUgPSB0aGlzLmdldEN1cnJlbnRTY29wZSgpO1xuXG4gICAgY29uc3QgbmFtZSA9IG5vZGUubmFtZTtcbiAgICBpZiAobmFtZS5raW5kID09PSB0cy5TeW50YXhLaW5kLklkZW50aWZpZXIpIHtcbiAgICAgIC8vIChuYW1lKVxuICAgICAgdGhpcy5pbnNwZWN0KHNjb3BlLCBuYW1lLmdldFRleHQoKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vICh7bmFtZX0pIG9yIChbbmFtZV0pIG9yIC4uLlxuICAgICAgdGhpcy5pbnNwZWN0QmluZGluZ3Moc2NvcGUsIG5hbWUpO1xuICAgIH1cbiAgfVxuXG4gIHByb3RlY3RlZCB2aXNpdElkZW50aWZpZXIobm9kZTogdHMuSWRlbnRpZmllcik6IHZvaWQge1xuICAgIGNvbnN0IGlkZW50ID0gbm9kZS5nZXRUZXh0KCksXG4gICAgICAgICAgaXNGYWlsdXJlID0gKGlkZW50ID09PSAnJCcgJiYgIXRoaXMuc2F3RG9sbGFyU2lnbigpKVxuICAgICAgICAgICAgICAgICAgIHx8IChpZGVudCA9PT0gJ2pRdWVyeScgJiYgIXRoaXMuc2F3SnF1ZXJ5KCkpO1xuXG4gICAgaWYgKGlzRmFpbHVyZSkge1xuICAgICAgdGhpcy5hZGRGYWlsdXJlKHRoaXMuY3JlYXRlRmFpbHVyZShub2RlLmdldFN0YXJ0KCksIG5vZGUuZ2V0V2lkdGgoKSwgUnVsZS5GQUlMVVJFX1NUUklORykpO1xuICAgIH1cbiAgfVxuXG4gIHByb3RlY3RlZCB2aXNpdFZhcmlhYmxlU3RhdGVtZW50KG5vZGU6IHRzLlZhcmlhYmxlU3RhdGVtZW50KTogdm9pZCB7XG4gICAgY29uc3QgbGlzdCA9IG5vZGUuZGVjbGFyYXRpb25MaXN0O1xuXG4gICAgY29uc3QgaXNCbG9ja1Njb3BlZCA9IChsaXN0LmZsYWdzICYgKHRzLk5vZGVGbGFncy5Db25zdCB8IHRzLk5vZGVGbGFncy5MZXQpKSAhPT0gMDtcblxuICAgIGNvbnN0IHNjb3BlID0gaXNCbG9ja1Njb3BlZCA/IHRoaXMuZ2V0Q3VycmVudEJsb2NrU2NvcGUoKSA6IHRoaXMuZ2V0Q3VycmVudFNjb3BlKCk7XG5cbiAgICBmb3IgKGNvbnN0IGRlY2wgb2YgbGlzdC5kZWNsYXJhdGlvbnMpIHtcbiAgICAgIHRoaXMuaW5zcGVjdERlY2xhcmF0aW9uKHNjb3BlLCBkZWNsKTtcbiAgICB9XG4gIH1cblxuICBwcm90ZWN0ZWQgdmlzaXRNZXRob2REZWNsYXJhdGlvbihub2RlOiB0cy5NZXRob2REZWNsYXJhdGlvbik6IHZvaWQge1xuICAgIGZvciAoY29uc3QgcGFyYW0gb2Ygbm9kZS5wYXJhbWV0ZXJzKSB7XG4gICAgICB0aGlzLnZpc2l0Tm9kZShwYXJhbSk7XG4gICAgfVxuXG4gICAgaWYgKG5vZGUuYm9keSkge1xuICAgICAgdGhpcy52aXNpdE5vZGUobm9kZS5ib2R5KTtcbiAgICB9XG4gIH1cblxuICBwcm90ZWN0ZWQgdmlzaXRQcm9wZXJ0eUFzc2lnbm1lbnQobm9kZTogdHMuUHJvcGVydHlBc3NpZ25tZW50KTogdm9pZCB7XG4gICAgdGhpcy52aXNpdE5vZGUobm9kZS5pbml0aWFsaXplcik7XG4gIH1cblxuICBwcm90ZWN0ZWQgdmlzaXRQcm9wZXJ0eUFjY2Vzc0V4cHJlc3Npb24obm9kZTogdHMuUHJvcGVydHlBY2Nlc3NFeHByZXNzaW9uKTogdm9pZCB7XG4gICAgdGhpcy52aXNpdE5vZGUobm9kZS5leHByZXNzaW9uKTtcbiAgfVxuXG4gIHByb3RlY3RlZCB2aXNpdFByb3BlcnR5RGVjbGFyYXRpb24obm9kZTogdHMuUHJvcGVydHlEZWNsYXJhdGlvbik6IHZvaWQge1xuICAgIGlmIChub2RlLmluaXRpYWxpemVyKSB7XG4gICAgICBzdXBlci52aXNpdE5vZGUobm9kZS5pbml0aWFsaXplcik7XG4gICAgfVxuICB9XG5cbiAgcHJvdGVjdGVkIGluc3BlY3RCaW5kaW5ncyhzY29wZTogU2F3SnF1ZXJ5U2NvcGUsIG5vZGU6IHRzLkJpbmRpbmdQYXR0ZXJuKTogdm9pZCB7XG4gICAgZm9yIChjb25zdCBiaW5kaW5nIG9mIG5vZGUuZWxlbWVudHMpIHtcbiAgICAgIGlmIChiaW5kaW5nLmtpbmQgIT09IHRzLlN5bnRheEtpbmQuT21pdHRlZEV4cHJlc3Npb24pIHtcbiAgICAgICAgdGhpcy5pbnNwZWN0QmluZGluZyhzY29wZSwgYmluZGluZyk7XG5cbiAgICAgICAgaWYgKGJpbmRpbmcuaW5pdGlhbGl6ZXIpIHtcbiAgICAgICAgICB0aGlzLnZpc2l0Tm9kZShiaW5kaW5nLmluaXRpYWxpemVyKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByb3RlY3RlZCBpbnNwZWN0QmluZGluZyhzY29wZTogU2F3SnF1ZXJ5U2NvcGUsIG5vZGU6IHRzLkJpbmRpbmdFbGVtZW50IHwgdHMuQXJyYXlCaW5kaW5nRWxlbWVudCk6IHZvaWQge1xuICAgIGlmIChub2RlLmtpbmQgPT09IHRzLlN5bnRheEtpbmQuQmluZGluZ0VsZW1lbnQpIHtcbiAgICAgIGNvbnN0IG5hbWUgPSBub2RlLm5hbWU7XG5cbiAgICAgIGlmIChuYW1lLmtpbmQgPT09IHRzLlN5bnRheEtpbmQuSWRlbnRpZmllcikge1xuICAgICAgICB0aGlzLmluc3BlY3Qoc2NvcGUsIG5hbWUuZ2V0VGV4dCgpKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuaW5zcGVjdEJpbmRpbmdzKHNjb3BlLCBuYW1lKTtcbiAgICAgIH1cblxuICAgICAgaWYgKG5vZGUuaW5pdGlhbGl6ZXIpIHtcbiAgICAgICAgdGhpcy52aXNpdE5vZGUobm9kZS5pbml0aWFsaXplcik7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJvdGVjdGVkIGluc3BlY3REZWNsYXJhdGlvbihzY29wZTogU2F3SnF1ZXJ5U2NvcGUsIG5vZGU6IHRzLlZhcmlhYmxlRGVjbGFyYXRpb24pIHtcbiAgICBjb25zdCBuYW1lID0gbm9kZS5uYW1lO1xuICAgIGlmIChuYW1lLmtpbmQgPT09IHRzLlN5bnRheEtpbmQuSWRlbnRpZmllcikge1xuICAgICAgdGhpcy5pbnNwZWN0KHNjb3BlLCBuYW1lLmdldFRleHQoKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuaW5zcGVjdEJpbmRpbmdzKHNjb3BlLCBuYW1lKTtcbiAgICB9XG5cbiAgICBpZiAobm9kZS5pbml0aWFsaXplcikge1xuICAgICAgdGhpcy52aXNpdE5vZGUobm9kZS5pbml0aWFsaXplcik7XG4gICAgfVxuICB9XG59XG4iXX0=